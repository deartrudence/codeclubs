<style>
  .custom-color-bg {
    background:<%= @lesson.custom_color %> !important;
  }

  .custom-color-text {
    color: <%= @lesson.custom_color %>;
  }

  .custom-color-title {
    color: <%= @lesson.custom_color %>;
    border-color: <%= @lesson.custom_color %>!important;
  }
</style>
<%= simple_form_for(@lesson) do |f| %>

  <% if @lesson.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@lesson.errors.count, "error") %> prohibited this lesson from being saved:</h2>

      <ul class="main">
      <% @lesson.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
  <header class="header--secondary custom-color-bg">
    <div class="wrapper--flex">
      <%if @lesson.title.present?%>
        <h2><%= @lesson.title%></h2>
      <% else %>
        <h2>Create a Lesson</h2>
      <% end %>
      <div class="lesson--single-actions">
        <% if current_user.admin? && @lesson.submitted%>
            <span>Update Status: </span>
           <div class="slideThree"> 
             <%= f.check_box :approved, data: @lesson.id, class: "lesson_approved_check", id: "slideThree#{@lesson.id}" %>
             <label for="slideThree<%= @lesson.id %>"></label>
           </div>
          <%= f.submit "Save Lesson", class: "button button--primary save-as-draft" %>
        <% end %>
        <% if !@lesson.submitted%>
          <%= f.submit "Save as Draft", class: "button button--secondary save-as-draft" %>
        <% end %>

        <% if @lesson.id.present? && !@lesson.submitted%>
          <%= link_to edit_lesson_path(@lesson, submitted: true), remote: true,  method: :get, class: 'button button--primary submit-button' do %>
           Submit
          <% end %> 
        <% end %>
      </div>
    </div>
  </header>
  <%if current_user.admin? && @lesson.id.present?%>
    <div class="lesson--admin-edit wrapper--flex">
      <div class="lesson--admin-edit-author"> 
        <label for="author">Author:</label>
        <input type="text" disabled value="<%= @lesson.author%>">
      </div>
      <div class="lesson--admin-edit-color">
        <%= f.label :custom_color, 'Custom Lesson Colour:'%>
        <%= f.text_field :custom_color %>
        <span class="color-swatch" style="background:<%= @lesson.custom_color%>;"></span>
      </div>
      <div class="lesson--admin-edit-verified">
        <%= f.label :verified, 'Lesson Verified?'%>
        <div class="select">
          <%= f.select :verified, [['Yes', true], ['No', false]] %>
        </div>
      </div>
      <div class="lesson--admin-edit-message">
        <%= f.label :verification_message, 'Badge Verification Message'%>
        <span class="label-direction">(30 characters maximum)</span>
        <div class="wrapper--flex">
          <span class="message-for">This lesson is verified for...</span>
          <%= f.text_field :verification_message, placeholder: 'The Provincial Curriculum' %>
        </div>
      </div>
    </div>
  <% end %>
  <div class="wrapper--flex">
    <div class="content">
      <h3 class="title--tertiary required custom-color-title">Lesson Info</h3>
      <%= f.label :title, class: 'required'%>
      <%= f.text_field :title %>
      <div class="wrapper--flex flex-even">
        <div>  
         <%= f.label :grade, class: 'required' %>
        <div class="select"> 
          <%= f.select :grade, options_for_select(Lesson::GRADE, @lesson.grade), {:include_blank => 'Choose'}%>
        </div>
        </div>
        <div>
          <%= f.label :duration_in_minutes %>
          <div class="select"> 
            <%= f.select :duration_in_minutes, options_for_select(Lesson::DURATION_IN_MINUTES, @lesson.duration_in_minutes), {:include_blank => 'Choose'}%>
          </div>

        </div>
      </div>

      <div>
        <h3 class="title--tertiary required custom-color-title">Short Summary</h3>
        <p class="small">Write a brief summary to introduce your lesson and provide context. This will appear on the main lesson dashboard as well as the top of your lesson page.</p>
        <%= f.text_area :description, placeholder: 'Write a short summary here' %>
      </div>
      <div>
        <h3 class="title--tertiary custom-color-title">Prep Work</h3>
        <p class="small">All the behind the scenes work to get the lesson ready.</p>
        <%= f.bootsy_area :prep, placeholder: 'Indicate any prep work required for this lesson, including any materials etc.' %>
      </div>
      <div class="textarea-content">
        <h3 class="title--tertiary required custom-color-title">The Lesson</h3>
        <p class="small">The actual meat of the lesson! This could take form of a step by step guide or maybe a series of little exercises, completely up to you!</p>
        <%= f.bootsy_area :content, placeholder: 'Write the content of your lesson, including all lecture notes and hands-on activity instructions here.', required: true %>
      </div>
      <div>
        <h3 class="title--tertiary custom-color-title">Assessment</h3>
        <p class="small">Either then answers to problems that are asked in the lesson or a guideline for some potential results of lesson completion.</p>
        <%= f.bootsy_area :answers, placeholder: 'Provide answers here.' %>
      </div>
      <div>
        <h3 class="title--tertiary custom-color-title">Extensions</h3>
        <p class="small">Additional questions and challenges that build on content reviewed in the lesson.</p>
        <%= f.bootsy_area :extensions, placeholder: 'Provide extensions here.' %>
      </div>
      <%= f.label :file_upload %>
      <p class="small">Upload additonal learning materials, reading, or slides.</p>
      <%= f.file_field :file_upload %>
      <%= f.label :video_link %>
      <p class="small">The embed link for any video material you may have that goes along with the lesson</p>
      <%= f.text_field :video_link, placeholder: 'Add link to video here' %>
      <% if !@lesson.submitted %>
        <%= f.submit "Save as Draft", class: "button button--secondary save-as-draft" %>
      <% end %>
      <% if @lesson.id.present? && !@lesson.submitted%>
        <%= link_to edit_lesson_path(@lesson, submitted: true), remote: true,  method: :get, class: 'button button--primary submit-button' do %>
         Submit
        <% end %>
        <%= link_to 'delete lesson', lesson_path(@lesson),
    data: { confirm: 'Are you sure you want to delete this lesson?' }, method: :delete, class: 'link--underlined delete-lesson'%>
      <% end %>
    </div>
    <!-- BEGINING OF SIDEBAR -->
    <div class="lesson--single-sidebar">
      <%= f.label 'Intended Province', :province, class: 'required'%>
      <div class="select"> 
        <%= f.select :province, options_for_select(Lesson::PROVINCES, @lesson.province)%>
      </div>
      <% if @lesson.feature_image.present? %>
        <%= image_tag @lesson.feature_image.url(:medium)%>
      <% end %>
      <%= f.label :feature_image, class: 'required' %>
      <%= f.file_field :feature_image, required: true %>
      <!-- TODO make semantic ui work -->
      <%= f.label 'Curriculum Subjects', :subject_list, class: 'required'%>
      <div class="select">    
        <%= f.select :subject_list, options_for_select(Lesson::CURRICULUM_SUBJECTS, @lesson.subject_list), {}, {multiple: true, class: 'curriculum_subjects_dropdown'}  %>
      </div>
      <div>
        <%= f.label 'Curriculum Takeaways', :curriculum_concepts%>
        <p class="small">An optional text field should you want to expand upon the curriculum subjects covered in the lesson.</p>
        <%= f.bootsy_area :curriculum_concepts, placeholder: 'Add any curriculum takeaways here.' %>
      </div>
      <%= f.label 'Coding Concepts', :code_concept_list, class: 'required' %>
      <div class="select">
        <%= f.select :code_concept_list, options_for_select(Lesson::CODING_CONCEPTS, @lesson.code_concept_list), {}, {class: 'coding_concepts_dropdown',multiple: true}  %>
      </div>
      <div>
        <%= f.label 'Coding Takeaways', :programming_concepts%>
        <p class="small">An optional text field should you want to expand upon the coding concepts covered in the lesson.</p>
        <%= f.bootsy_area :programming_concepts, placeholder: 'Add any coding takeaways here.' %>
      </div>
      <% if current_user.profile.is_admin? %>
      <div>
        <h3>References</h3>
        <p class="small">List any references you used or found useful in the creation of this lesson.</p>
        <%= f.fields_for :lesson_references do |builder| %>
          <%= render 'lesson_reference_fields', f: builder %>
        <% end %>
        <%= link_to_add_fields "+ more", f, :lesson_references  %>
      </div>
      <div>
        <h3>Suggested Lessons</h3>
        <p class="small">Lessons that would nicely complement this one or provide a good extension.</p>
        <div class="select">
          <%= f.collection_select :suggested_lessons, Lesson.where.not(id: @lesson.id).is_approved, :id, :title, {:include_blank => false}, {multiple: true, class: 'suggested_lessons_dropdown'}  %>
        </div>
        <% if @lesson.suggested_lessons.present?%>
          <ul class="list--suggested-lessons-edit">
            <%@lesson.suggested_lessons.each do |sug_lesson|%>
              <% if sug_lesson.suggested_lesson_id > 0%>
                <% the_lesson = Lesson.where(id: sug_lesson.suggested_lesson_id.to_i).first%>
                  <li id="sug_<%= sug_lesson.id%>"><%= link_to 'Ã—', sug_lesson, method: :delete, data: { confirm: 'Are you sure?' }, :remote => true, class: 'suggested-delete custom-color-bg' %> <%= link_to the_lesson.title, lesson_path(the_lesson) %></li>
              <% end %>
        
            <% end %>
          </ul>
        <% end %>
      </div>
      <% end %>

    </div>
  </div>
<% end %>

<script>
$(function(){
  $('.curriculum_subjects_dropdown').select2()
  $('.coding_concepts_dropdown').select2()
  $('.suggested_lessons_dropdown').select2()

})
  ;
  function ajaxSubmitInput(elem) {
    console.log(elem)
    // $.ajax({
    //   url: '',  
    //   method: 'GET', 
    //   data: data
    // });
  }
</script>

<script>
$(document).ready(function(){
  console.log('ready')
  $('form').on('click', '.remove_fields', function(even){
    event.preventDefault()
    $(this).prev('input[type=hidden]').val('1');
    $(this).closest('fieldset').hide();
  });
  
  $('form').on('click', '.add_fields', function(event){
    event.preventDefault();
    time = new Date().getTime();
    regexp = new RegExp($(this).data('id'), 'g');
    console.log(regexp)
    $(this).before($(this).data('fields').replace(regexp, time));

  })
});
  
</script>