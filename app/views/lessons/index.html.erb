<p id="notice"><%= notice %></p>

<h1>Listing Lessons</h1>

<h4>Subject</h4>
<ul>
  <% ActsAsTaggableOn::Tagging.includes(:tag).where(context: 'subject').uniq.pluck(:name).each do |subject| %>
  <li><%= subject %></li>
  <% end %>
</ul>
<h4>Code Concept</h4>
<ul>
  <% ActsAsTaggableOn::Tagging.includes(:tag).where(context: 'code_concept').uniq.pluck(:name).each do |code_concept| %>
  <li><%= code_concept %></li>
  <% end %>
</ul>
<h4>Grade</h4>
<ul>
  <% ActsAsTaggableOn::Tagging.includes(:tag).where(context: 'grade').uniq.pluck(:name).each do |grade| %>
  <li><%= grade %></li>
  <% end %>
</ul>
<% @lessons.each do |lesson| %>
<div class="container container--flex container--lesson lesson col--two">
  <div class="lesson--bar">
    <% ActsAsTaggableOn::Tagging.includes(:tag).where(context: 'grade').uniq.pluck(:name).each do |grade| %>
    <span>Grade:  <%= grade %></span>
    <% end %>
  </div>

  <div class="lesson--title">
    <span>
      <p>Time: <%= lesson.duration_in_seconds %></p>
      <p>Level: <%= lesson.level%></p>
    </span>
    <h2><%= lesson.title %></h2>
  </div>

  <div class="lesson--short-description">
    <p><%= lesson.short_description.html_safe %></p>
    <%= link_to 'Learn More', lesson, class: 'button button--primary' %>

    <span class="lesson--likes">

    <%= link_to like_lesson_path(lesson), "data-liked" => lesson.liked_by_user(current_user), class: "likes", remote: true,  method: :get, data: { type: :json } do %>
      â™¡
      <span class="likes-count"><%= lesson.get_upvotes.size %></span>
    <% end %>
    </span>
  </div>
</div>
<%= link_to dislike_lesson_path(lesson), method: :put do %>
  Downvote
  <%= lesson.get_downvotes.size %>
<% end %>


<% end %>
<br>

<%= link_to 'New Lesson', new_lesson_path %>

<script>
  function updateVotable(){
    $('.likes').each(function(i, lesson){
      var status = $(lesson).data('liked');
      var url = $(lesson).attr('href')
      var href = url.split('/')
      href.pop()
      var url_start = href.join('/')
      if(status == true){
        console.log(i + 'true')
        $(lesson).attr('href', url_start + '/dislike')
      }else if(status == false){
        $(lesson).attr('href', url_start + '/like')
        console.log(i + 'false')
      }
    })
  }
  $(document).ready(function(){
    $('.likes').on('click', function(e){
      e.preventDefault()

    })
    $('.likes').on('ajax:success', function(e, data, status, xhr){
      console.log(data.count)
      var count = data.count
      var liked = $(this).data('liked')
      $(this).find('.likes-count').html(count)
      if(liked == true){
        $(this).data('liked', false)
      }else if(liked == false){
        $(this).data('liked', true)
      }
      updateVotable();
    });
    updateVotable();
  });
</script>
